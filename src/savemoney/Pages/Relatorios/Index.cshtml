@page
@model savemoney.Pages.Relatorios.IndexModel

@{
    ViewData["Title"] = "Relatório Financeiro";
}

<h2>@ViewData["Title"]</h2>

<form method="post" id="reportForm">
    @Html.AntiForgeryToken()

    <div>
        <label>Data início</label>
        <input asp-for="Request.StartDate" type="date" class="form-control" />
        <span asp-validation-for="Request.StartDate" class="text-danger"></span>
    </div>

    <div>
        <label>Data fim</label>
        <input asp-for="Request.EndDate" type="date" class="form-control" />
        <span asp-validation-for="Request.EndDate" class="text-danger"></span>
    </div>

    <div>
        <label>Período</label>
        <select asp-for="Request.Period" class="form-control">
            <option value="Weekly">Semanal</option>
            <option value="Monthly">Mensal</option>
            <option value="Yearly">Anual</option>
        </select>
    </div>

    <div style="margin-top:10px;">
        <button type="submit" class="btn btn-primary">Gerar</button>
        <button type="submit" name="handler" value="ExportExcel" class="btn btn-outline-secondary" onclick="return prepareExport()">Exportar Excel</button>
        <button type="submit" name="handler" value="ExportPdf" class="btn btn-outline-secondary" onclick="return prepareExport()">Exportar PDF</button>
    </div>

    <input type="hidden" asp-for="ChartImageBase64" id="ChartImage" />
    <input type="hidden" asp-for="PieImageBase64" id="PieImage" />
</form>

<hr />

<!-- diagnóstico rápido para debug -->
<p>Qtd períodos: @(Model.ViewModel?.Periodos?.Count())</p>

@if (Model.ViewModel?.Periodos != null && Model.ViewModel.Periodos.Count > 0)
{
    <h4>Resumo (DRE)</h4>
    <p>Total Receitas: R$ @(Model.ViewModel.TotalReceitas.ToString("N2"))</p>
    <p>Total Despesas: R$ @(Model.ViewModel.TotalDespesas.ToString("N2"))</p>
    <p>Saldo: R$ @(Model.ViewModel.Saldo.ToString("N2"))</p>

    <canvas id="barChart" height="150"></canvas>
    <canvas id="pieChart" height="150"></canvas>

    <table class="table table-sm">
        <thead><tr><th>Período</th><th class="text-end">Receitas</th><th class="text-end">Despesas</th><th class="text-end">Saldo</th></tr></thead>
        <tbody>
            @foreach (var p in Model.ViewModel.Periodos)
            {
                <tr>
                    <td>@p.Label</td>
                    <td class="text-end">@p.TotalReceitas.ToString("N2")</td>
                    <td class="text-end">@p.TotalDespesas.ToString("N2")</td>
                    <td class="text-end">@p.Saldo.ToString("N2")</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info">Nenhum dado encontrado para o período selecionado.</div>
}

@section Scripts {
    <script>
        const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ViewModel?.Periodos?.Select(p => p.Label) ?? Array.Empty<string>()));
        const receitas = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ViewModel?.Periodos?.Select(p => p.TotalReceitas) ?? Array.Empty<double>()));
        const despesas = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ViewModel?.Periodos?.Select(p => p.TotalDespesas) ?? Array.Empty<double>()));
        const totalReceitas = @(Model.ViewModel?.TotalReceitas ?? 0);
        const totalDespesas = @(Model.ViewModel?.TotalDespesas ?? 0);

        window.relatorioData = { labels, receitas, despesas, totalReceitas, totalDespesas };

        // função chamada pelos botões de export (retorna true para permitir submit)
        function prepareExport() {
            try {
                // espera que relatorio.js já tenha criado os charts e exposto as imagens
                const barInput = document.getElementById('ChartImage');
                const pieInput = document.getElementById('PieImage');

                // se relatorio.js criou os charts e expôs as imagens em window, usar
                if (window.__chartImageBase64) barInput.value = window.__chartImageBase64;
                if (window.__pieImageBase64) pieInput.value = window.__pieImageBase64;

                // se não tiver imagens, não impede o submit: exportará sem gráfico
                return true;
            } catch (err) {
                console.error('Erro ao preparar export:', err);
                return true;
            }
        }
    </script>

    <script src="~/js/relatorio.js" asp-append-version="true"></script>
}
