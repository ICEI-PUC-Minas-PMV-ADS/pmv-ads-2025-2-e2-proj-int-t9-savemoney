@model savemoney.Models.Budget
@using savemoney.Models

<div class="modal fade"
     id="budgetModal"
     tabindex="-1"
     aria-labelledby="budgetModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content glass-panel premium-modal">

            <form action="/Budgets/@(Model.Id == 0 ? "Create" : "Edit")/@(Model.Id == 0 ? "" : Model.Id)"
                  method="post"
                  aria-labelledby="budgetModalLabel">
                @Html.AntiForgeryToken()

                @if (Model.Id != 0)
                {
                    <input type="hidden" name="Id" value="@Model.Id" />
                    <input type="hidden" name="UserId" value="@Model.UserId" />
                }

                <div class="modal-header-clean">
                    <div>
                        <h2 id="budgetModalLabel" class="modal-title">
                            @(Model.Id == 0 ? "Novo Orçamento" : "Editar Orçamento")
                        </h2>
                        <p class="modal-subtitle">Defina limites para controlar seus gastos.</p>
                    </div>
                    <button type="button"
                            class="btn-close-custom"
                            data-bs-dismiss="modal"
                            aria-label="Fechar">
                        <i class="bi bi-x-lg" aria-hidden="true"></i>
                    </button>
                </div>

                <div class="modal-body-clean">

                    <div class="form-group">
                        <label asp-for="Name" class="form-label">Nome do Orçamento</label>
                        <input asp-for="Name"
                               class="form-input"
                               placeholder="Ex: Orçamento Familiar 2025, Viagem..."
                               required />
                        <span asp-validation-for="Name" class="form-error"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="Description" class="form-label">Descrição (Opcional)</label>
                        <textarea asp-for="Description"
                                  class="form-input"
                                  rows="2"
                                  placeholder="Detalhes sobre este planejamento..."></textarea>
                    </div>

                    <div class="form-grid-2">
                        <div class="form-group">
                            <label asp-for="StartDate" class="form-label">Início</label>
                            <input type="date"
                                   asp-for="StartDate"
                                   class="form-input"
                                   required />
                        </div>
                        <div class="form-group">
                            <label asp-for="EndDate" class="form-label">Término</label>
                            <input type="date"
                                   asp-for="EndDate"
                                   class="form-input"
                                   required />
                        </div>
                    </div>

                    <div class="form-divider"></div>

                    <div class="form-group">
                        <label asp-for="Status" class="form-label">Status</label>
                        <select asp-for="Status"
                                asp-items="Html.GetEnumSelectList<BudgetStatus>()"
                                class="form-input">
                        </select>
                    </div>

                    <div class="categories-section">
                        <div class="categories-header">
                            <label class="form-label mb-0">Categorias e Limites</label>
                            <button type="button"
                                    class="btn-action btn-sm btn-secondary"
                                    id="addCategoryBtn"
                                    aria-label="Adicionar categoria">
                                <i class="bi bi-plus-lg" aria-hidden="true"></i>
                                Adicionar
                            </button>
                        </div>

                        <div class="category-list-header">
                            <span>CATEGORIA</span>
                            <span>LIMITE (R$)</span>
                            <span></span>
                        </div>

                        <div id="categoriesContainer" class="categories-list">
                            @if (Model.Categories != null && Model.Categories.Any())
                            {
                                for (int i = 0; i < Model.Categories.Count; i++)
                                {
                                    <div class="category-row">
                                        <select name="Categories[@i].CategoryId"
                                                class="form-input form-input-sm"
                                                required>
                                            <option value="">Selecione...</option>
                                            @foreach (var item in ViewBag.AvailableCategories)
                                            {
                                                <option value="@item.Value"
                                                        selected="@(item.Value == Model.Categories[i].CategoryId.ToString() ? "selected" : null)">
                                                    @item.Text
                                                </option>
                                            }
                                        </select>
                                        <input name="Categories[@i].Limit"
                                               value="@Model.Categories[i].Limit.ToString("F2")"
                                               type="text"
                                               class="form-input form-input-sm money-mask"
                                               placeholder="0,00"
                                               required />
                                        <button type="button"
                                                class="btn-icon danger"
                                                onclick="this.closest('.category-row').remove()"
                                                aria-label="Remover categoria">
                                            <i class="bi bi-trash" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                }
                            }
                        </div>

                        <div id="emptyTableMsg"
                             class="empty-categories-msg @(Model.Categories != null && Model.Categories.Any() ? "d-none" : "")">
                            <i class="bi bi-layers" aria-hidden="true"></i>
                            <span>Nenhuma categoria definida.<br />O orçamento será global.</span>
                        </div>
                    </div>

                </div>

                <div class="modal-footer-clean">
                    <button type="button"
                            class="btn-action btn-secondary"
                            data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-action btn-primary">
                        Salvar Orçamento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<partial name="_ValidationScriptsPartial" />

<script id="categoryRowTemplate" type="text/template">
    <div class="category-row">
        <select name="Categories[{INDEX}].CategoryId" class="form-input form-input-sm" required>
            <option value="">Selecione...</option>
            @foreach (var item in ViewBag.AvailableCategories)
            {
                    <option value="@item.Value">@item.Text</option>
            }
        </select>
        <input name="Categories[{INDEX}].Limit"
               type="text"
               class="form-input form-input-sm money-mask"
               placeholder="0,00"
               required />
        <button type="button"
                class="btn-icon danger"
                onclick="removerLinha(this)"
                aria-label="Remover categoria">
            <i class="bi bi-trash" aria-hidden="true"></i>
        </button>
    </div>
</script>