@model savemoney.Models.Budget
@{
    ViewData["Title"] = "Detalhes do Orçamento - " + Model.Name;
}

<div class="container mt-5">
    <div class="row">
        <!-- INFORMAÇÕES DO ORÇAMENTO -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">@Model.Name</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        <small class="opacity-75">
                            <i class="bi bi-calendar3 me-1"></i>
                            @Model.StartDate.ToString("dd/MM/yyyy") até @Model.EndDate.ToString("dd/MM/yyyy")
                        </small>
                    </p>
                    <p>
                        <strong>Status:</strong>
                        <span class="badge @(Model.Status == BudgetStatus.Ativo ? "bg-success" : Model.Status == BudgetStatus.Concluido ? "bg-info" : "bg-secondary")">
                            @Model.Status
                        </span>
                    </p>
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <p><strong>Descrição:</strong> @Model.Description</p>
                    }
                    <hr />
                    <div class="d-grid gap-2">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="bi bi-trash"></i> Excluir
                        </button>
                        <a asp-action="ExportPdf" asp-route-id="@Model.Id" class="btn btn-outline-success">
                            <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRÁFICO DE PIZZA + TABELA -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Distribuição de Gastos</h5>
                </div>
                <div class="card-body">
                    <canvas id="pieChart" height="300"></canvas>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Detalhes por Categoria</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Categoria</th>
                                    <th class="text-end">Limite</th>
                                    <th class="text-end">Gasto</th>
                                    <th class="text-center">Progresso</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var bc in Model.Categories)
                                {
                                    var percent = bc.Limit > 0 ? (bc.CurrentSpent / bc.Limit) * 100 : 0;
                                    var statusClass = percent > 100 ? "bg-danger" : percent > 80 ? "bg-warning" : "bg-success";

                                    <tr>
                                        <td>@bc.Category.Name</td>
                                        <td class="text-end">R$ @bc.Limit.ToString("F2")</td>
                                        <td class="text-end">R$ @bc.CurrentSpent.ToString("F2")</td>
                                        <td>
                                            <div class="progress" style="height: 25px;">
                                                <div class="progress-bar @statusClass"
                                                     style="width: @Math.Min(percent, 100)%">
                                                    @percent.ToString("F1")%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL CONFIRMAÇÃO EXCLUSÃO -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o orçamento <strong>@Model.Name</strong>?</p>
                <p class="text-danger">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form asp-action="Delete" asp-route-id="@Model.Id" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">Sim, Excluir</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('pieChart').getContext('2d');

            // Usa o Model.Categories que já está carregado (sem Json.Serialize!)
            const categories = @Html.Raw(Json.Serialize(Model.Categories.Select(bc => new {
                name = bc.Category?.Name ?? "Sem categoria",
                spent = bc.CurrentSpent
            })));

            if (categories.length === 0) {
                ctx.canvas.parentNode.innerHTML = '<p class="text-muted text-center">Nenhuma categoria adicionada ainda.</p>';
                return;
            }

            const labels = categories.map(c => c.name);
            const data = categories.map(c => c.spent);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#C9CBCF', '#E7E9ED', '#76D7C4', '#F5B7B1'
                        ],
                        hoverOffset: 30
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: R$ ${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>
}