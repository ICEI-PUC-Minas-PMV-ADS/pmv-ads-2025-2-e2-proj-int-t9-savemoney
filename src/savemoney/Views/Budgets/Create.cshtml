@model savemoney.Models.Budget
@{
    ViewData["Title"] = "Criar Orçamento";
    var categories = ViewBag.Categories as List<savemoney.Models.Category>;
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">@ViewData["Title"]</h3>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <!-- DADOS DO ORÇAMENTO -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-8">
                                <label asp-for="Name" class="form-label fw-bold"></label>
                                <input asp-for="Name" class="form-control" placeholder="Ex: Orçamento de Janeiro" />
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Status" class="form-label fw-bold"></label>
                                <select asp-for="Status" class="form-select">
                                    <option value="0">Ativo</option>
                                    <option value="1">Concluído</option>
                                    <option value="2">Arquivado</option>
                                </select>
                                <span asp-validation-for="Status" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label"></label>
                            <textarea asp-for="Description" class="form-control" rows="2" placeholder="Descrição opcional..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label asp-for="StartDate" class="form-label fw-bold"></label>
                                <input asp-for="StartDate" class="form-control" type="date" />
                                <span asp-validation-for="StartDate" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EndDate" class="form-label fw-bold"></label>
                                <input asp-for="EndDate" class="form-control" type="date" />
                                <span asp-validation-for="EndDate" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="UserId" class="form-label fw-bold"></label>
                            <select asp-for="UserId" class="form-select" asp-items="ViewBag.UserId"></select>
                            <span asp-validation-for="UserId" class="text-danger"></span>
                        </div>

                        <!-- CATEGORIAS DINÂMICAS -->
                        <hr class="my-4" />
                        <h5 class="mb-3">Categorias do Orçamento</h5>

                        <table class="table table-bordered align-middle" id="categoriesTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50%">Categoria</th>
                                    <th style="width: 35%">Limite (R$)</th>
                                    <th style="width: 15%"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Linhas adicionadas via JS -->
                            </tbody>
                        </table>

                        <button type="button" class="btn btn-outline-success btn-sm mb-3" onclick="addCategoryRow()">
                            + Adicionar Categoria
                        </button>

                        <!-- BOTÕES -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                Criar Orçamento
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                Voltar à Lista
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        let rowIndex = 0;
        const categories = @Html.Raw(Json.Serialize(categories));

        function addCategoryRow() {
            const table = document.querySelector('#categoriesTable tbody');
            const row = table.insertRow();

            row.innerHTML = `
                <td>
                    <select name="Categories[${rowIndex}].CategoryId" class="form-select form-select-sm" required>
                        <option value="">Selecione uma categoria...</option>
                        ${categories.map(cat =>
                            `<option value="${cat.id}">${cat.name}</option>`
                        ).join('')}
                    </select>
                </td>
                <td>
                    <input name="Categories[${rowIndex}].Limit"
                           type="number"
                           step="0.01"
                           min="0.01"
                           class="form-control form-control-sm"
                           placeholder="0,00"
                           required />
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm"
                            onclick="this.closest('tr').remove()">
                        Remover
                    </button>
                </td>
            `;
            rowIndex++;
        }

        // Adiciona uma linha ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            if (rowIndex === 0) addCategoryRow();
        });
    </script>
}