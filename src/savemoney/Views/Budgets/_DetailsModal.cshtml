@model savemoney.Models.Budget
@using System.Globalization

@{
    var totalLimit = Model.Categories.Sum(c => c.Limit);
    var totalSpent = Model.Categories.Sum(c => c.CurrentSpent);
    var percentage = totalLimit > 0 ? (totalSpent / totalLimit) * 100 : 0;
    var limitCss = totalLimit.ToString("F2", CultureInfo.InvariantCulture);
    var statusColor = percentage >= 100 ? "text-danger" : percentage >= 80 ? "text-warning" : "text-success";

    var chartData = Model.Categories.Select(c => new
    {
        label = c.Category.Name,
        value = c.CurrentSpent
    }).ToList();
}

<div class="modal-header">
    <div>
        <h2 class="modal-title">@Model.Name</h2>
        <div class="modal-meta">
            <span class="badge @(Model.Status == savemoney.Models.BudgetStatus.Ativo ? "badge-success" : "badge-secondary")">
                @Model.Status
            </span>
            <span class="modal-date">
                <i class="bi bi-calendar3 me-1" aria-hidden="true"></i>
                <time datetime="@Model.StartDate.ToString("yyyy-MM-dd")">@Model.StartDate.ToString("dd/MM/yyyy")</time>
                -
                <time datetime="@Model.EndDate.ToString("yyyy-MM-dd")">@Model.EndDate.ToString("dd/MM/yyyy")</time>
            </span>
        </div>
    </div>
    <button type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Fechar"></button>
</div>

<div class="modal-body">

    <!-- Gráfico e resumo -->
    <div class="details-grid">
        <!-- Coluna do gráfico -->
        <div class="chart-column">
            <div class="chart-container">
                <canvas id="budgetDonutChart"
                        width="180"
                        height="180"
                        data-chart='@Json.Serialize(chartData)'
                        data-limit="@limitCss"
                        aria-label="Gráfico de distribuição de gastos"></canvas>

                <div class="chart-label">
                    <span class="chart-label-text">Consumido</span>
                    <strong class="chart-label-value">@percentage.ToString("F0")%</strong>
                </div>
            </div>
        </div>

        <!-- Coluna de valores -->
        <div class="summary-column">
            <div class="summary-card">
                <span class="summary-label">Limite Total</span>
                <span class="summary-value">@totalLimit.ToString("C")</span>
            </div>
            <div class="summary-card">
                <span class="summary-label">Total Gasto</span>
                <span class="summary-value @statusColor">
                    @totalSpent.ToString("C")
                </span>
            </div>
        </div>
    </div>

    <!-- Descrição -->
    @if (!string.IsNullOrEmpty(Model.Description))
    {
        <div class="alert-info">
            @Model.Description
        </div>
    }

    <!-- Detalhamento -->
    <h3 class="section-title">Detalhamento por Categoria</h3>

    <div class="categories-detail-list">
        @foreach (var cat in Model.Categories)
        {
            var catPercent = cat.Limit > 0 ? (cat.CurrentSpent / cat.Limit) * 100 : 0;
            var catWidthCss = Math.Min(catPercent, 100).ToString("F1", CultureInfo.InvariantCulture);
            var catColor = catPercent >= 100 ? "bg-danger" : catPercent >= 80 ? "bg-warning" : "bg-success";

            <div class="category-detail-item">
                <div class="category-detail-header">
                    <span class="category-name">@cat.Category.Name</span>
                    <span class="category-amounts">
                        <strong>@cat.CurrentSpent.ToString("C")</strong>
                        / @cat.Limit.ToString("C")
                    </span>
                </div>

                <div class="progress-container"
                     role="progressbar"
                     aria-valuenow="@catPercent.ToString("F0")"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     aria-label="Progresso de @cat.Category.Name">
                    <div class="progress-bar @catColor" style="width: @catWidthCss%"></div>
                </div>
            </div>
        }
    </div>
</div>

<div class="modal-footer">
    <a asp-action="ExportPdf"
       asp-route-id="@Model.Id"
       class="btn-action btn-outline"
       target="_blank"
       aria-label="Exportar relatório em PDF">
        <i class="bi bi-file-earmark-pdf" aria-hidden="true"></i>
        Exportar PDF
    </a>
    <button type="button"
            class="btn-action btn-secondary"
            data-bs-dismiss="modal">
        Fechar
    </button>
    <button type="button"
            class="btn-action btn-primary"
            onclick="carregarModalEditar(@Model.Id)"
            aria-label="Editar orçamento @Model.Name">
        <i class="bi bi-pencil me-1" aria-hidden="true"></i>
        Editar
    </button>
</div>