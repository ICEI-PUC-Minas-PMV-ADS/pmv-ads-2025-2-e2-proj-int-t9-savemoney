@model savemoney.Models.Budget
@using System.Globalization

@{
    // Cálculos Gerais
    var totalLimit = Model.Categories.Sum(c => c.Limit);
    var totalSpent = Model.Categories.Sum(c => c.CurrentSpent);

    // Evita divisão por zero
    var percentage = totalLimit > 0 ? (totalSpent / totalLimit) * 100 : 0;

    // Formatação para CSS (Ponto ao invés de vírgula)
    var percentageCss = Math.Min(percentage, 100).ToString("F1", CultureInfo.InvariantCulture);

    // --- CORREÇÃO DO ERRO AQUI ---
    // Define a variável limitCss para usar no Canvas
    var limitCss = totalLimit.ToString("F2", CultureInfo.InvariantCulture);

    // Cores dinâmicas
    var statusColor = percentage >= 100 ? "text-danger" : percentage >= 80 ? "text-warning" : "text-success";
    var progressBarColor = percentage >= 100 ? "bg-danger" : percentage >= 80 ? "bg-warning" : "bg-success";

    // Dados para o Gráfico
    var chartData = Model.Categories.Select(c => new
    {
        label = c.Category.Name,
        value = c.CurrentSpent
    }).ToList();
}

<div class="modal-header border-0 pb-0">
    <div>
        <h5 class="modal-title text-white fw-bold">@Model.Name</h5>
        <div class="d-flex align-items-center gap-2 mt-1">
            <span class="badge @(Model.Status == savemoney.Models.BudgetStatus.Ativo ? "bg-success" : "bg-secondary")">
                @Model.Status
            </span>
            <small class="text-muted">
                <i class="bi bi-calendar3 me-1"></i>
                @Model.StartDate.ToString("dd/MM/yyyy") - @Model.EndDate.ToString("dd/MM/yyyy")
            </small>
        </div>
    </div>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">

    <div class="row g-4 mb-4">
        <div class="col-md-5 d-flex flex-column align-items-center justify-content-center">
            <div style="position: relative; width: 180px; height: 180px;">
                <canvas id="budgetDonutChart" width="180" height="180"
                        data-chart='@Json.Serialize(chartData)'
                        data-limit="@limitCss"></canvas>

                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none;">
                    <span class="d-block text-muted small text-uppercase" style="font-size: 0.7rem;">Consumido</span>
                    <strong class="text-white fs-3">@percentage.ToString("F0")%</strong>
                </div>
            </div>
        </div>

        <div class="col-md-7 d-flex flex-column justify-content-center">
            <div class="glass-panel p-3 mb-3" style="background: rgba(255,255,255,0.03);">
                <span class="text-muted small d-block">Limite Total</span>
                <span class="text-white fs-5 fw-bold">@totalLimit.ToString("C")</span>
            </div>
            <div class="glass-panel p-3" style="background: rgba(255,255,255,0.03);">
                <span class="text-muted small d-block">Total Gasto</span>
                <span class="@statusColor fs-5 fw-bold">
                    @totalSpent.ToString("C")
                </span>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.Description))
    {
        <div class="alert custom-alert-dark py-2 px-3 mb-4 border-start border-primary border-3" style="background: rgba(255,255,255,0.02);">
            <small class="text-muted">@Model.Description</small>
        </div>
    }

    <h6 class="text-white fw-bold mb-3 pb-2 border-bottom border-secondary border-opacity-25">
        Detalhamento por Categoria
    </h6>

    <div class="d-flex flex-column gap-3" style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
        @foreach (var cat in Model.Categories)
        {
            var catPercent = cat.Limit > 0 ? (cat.CurrentSpent / cat.Limit) * 100 : 0;
            var catWidthCss = Math.Min(catPercent, 100).ToString("F1", CultureInfo.InvariantCulture);
            var catColor = catPercent >= 100 ? "bg-danger" : catPercent >= 80 ? "bg-warning" : "bg-primary";

            <div class="p-2 rounded hover-bg" style="transition: background 0.2s;">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="text-white fw-medium">@cat.Category.Name</span>
                    <span class="small text-muted">
                        <span class="text-white">@cat.CurrentSpent.ToString("C")</span> / @cat.Limit.ToString("C")
                    </span>
                </div>

                <div class="progress" style="height: 6px; background-color: rgba(255,255,255,0.05);">
                    <div class="progress-bar @catColor rounded-pill"
                         role="progressbar"
                         style="width: @catWidthCss%"></div>
                </div>
            </div>
        }
    </div>
</div>

<div class="modal-footer border-0 pt-0">
    <a asp-action="ExportPdf" asp-route-id="@Model.Id" class="btn btn-outline-light btn-sm" target="_blank">
        <i class="bi bi-file-earmark-pdf"></i> PDF
    </a>
    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
    <button type="button" class="btn btn-primary btn-sm" onclick="carregarModalEditar(@Model.Id)">
        <i class="bi bi-pencil me-1"></i> Editar
    </button>
</div>