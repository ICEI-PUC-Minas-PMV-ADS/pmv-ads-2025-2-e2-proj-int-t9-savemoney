@* _Header.cshtml - Menu Geral (Contém todas as funcionalidades) *@
@using System.Security.Claims

@{
    var usuario = ViewBag.Usuario as savemoney.Models.Usuario;
}

<header id="main-header">
    <div class="header-container">

        <a href="/" class="header-logo" title="Início">
            Save Money
        </a>

        <nav class="header-nav">
            <ul class="header-nav-links">

                <li class="header-dropdown">
                    <a href="#">Finanças <i class="bi bi-chevron-down"></i></a>
                    <ul class="header-dropdown-menu">
                        <li><a asp-controller="Receitas" asp-action="Index">Receitas</a></li>
                        <li><a asp-controller="Despesas" asp-action="Index">Despesas</a></li>
                        <li><a asp-controller="Historico" asp-action="Index">Histórico</a></li>
                        <li><a asp-controller="Categories" asp-action="Index">Categorias</a></li>
                    </ul>
                </li>

                <li class="header-dropdown">
                    <a href="#">Planejamento <i class="bi bi-chevron-down"></i></a>
                    <ul class="header-dropdown-menu">
                        <li><a asp-controller="Budgets" asp-action="Index">Orçamentos</a></li>
                        <li><a asp-controller="MetasFinanceiras" asp-action="Index">Objetivos</a></li>
                        <li><a asp-controller="ProjecaoFinanceira" asp-action="Index">Projeção Futura</a></li>
                    </ul>
                </li>

                <li class="header-dropdown">
                    <a href="#">Corporativo <i class="bi bi-chevron-down"></i></a>
                    <ul class="header-dropdown-menu">
                        <li><a asp-controller="DreGerencial" asp-action="Index">DRE Gerencial</a></li>
                        <li><a asp-controller="KpisCorporativos" asp-action="Index">KPIs Corporativos</a></li>
                    </ul>
                </li>

                <li class="header-dropdown">
                    <a href="#">Análises <i class="bi bi-chevron-down"></i></a>
                    <ul class="header-dropdown-menu">
                        <li><a asp-controller="Relatorios" asp-action="Index">Relatórios</a></li>
                        <li><a asp-controller="TendenciaFinanceira" asp-action="Index">Tendências</a></li>
                    </ul>
                </li>

                <li class="header-dropdown">
                    <a href="#">Conteúdo <i class="bi bi-chevron-down"></i></a>
                    <ul class="header-dropdown-menu">
                        <li><a asp-controller="EducacaoFinanceira" asp-action="Index">Aprender</a></li>
                        <li><a asp-controller="Artigos" asp-action="Index">Artigos</a></li>
                        <li><a asp-controller="Noticias" asp-action="Index">Notícias</a></li>
                    </ul>
                </li>

                <li class="header-dropdown">
                    <a href="#">Ferramentas <i class="bi bi-chevron-down"></i></a>
                    <ul class="header-dropdown-menu">
                        <li><a asp-controller="Ferramentas" asp-action="CalculadoraDeMetas">Calculadora</a></li>
                        <li><a asp-controller="Ferramentas" asp-action="JurosCompostos">Juros Compostos</a></li>
                        <li><a asp-controller="ConversorEnergias" asp-action="Index">Energia</a></li>
                    </ul>
                </li>

                @if (User.IsInRole("Administrador"))
                {
                    <li><a asp-controller="Usuarios" asp-action="Index" class="text-danger">Admin</a></li>
                }
            </ul>
        </nav>

        <div class="header-actions">
            @if (User.Identity != null && User.Identity.IsAuthenticated)
            {
                // **INÍCIO DA CORREÇÃO** - Só tenta usar 'usuario' se ele não for nulo
                if (usuario != null)
                {
                    var userName = usuario.Nome ?? User.Identity.Name ?? "User"; // Prefere o nome do objeto Usuario
                                                                                 // Se o avatar for exibido, as iniciais não são necessárias, mas vamos mantê-las por segurança se houver fallback CSS.
                                                                                 // var initials = userName.Length >= 2 ? userName.Substring(0, 2).ToUpper() : userName.ToUpper();

                    <div class="header-user-avatar user-avatar-small" title="@userName">
                        @* Linha que causava o erro (agora protegida) *@
                        <img src="@usuario.FotoPerfil" alt="@usuario.Nome" id="avatarImage">
                    </div>
                }
                else
                {
                    // Opcional: Fallback visual se o objeto 'usuario' falhar ao carregar,
                    // mas o usuário ainda estiver logado (baseado no cookie/token).
                    var fallbackName = User.Identity.Name ?? "User";
                    var fallbackInitials = fallbackName.Length >= 2 ? fallbackName.Substring(0, 2).ToUpper() : fallbackName.ToUpper();

                    // Exibir as iniciais como fallback de avatar
                    <div class="header-user-avatar user-avatar-small fallback-initials" title="@fallbackName">
                        @fallbackInitials
                    </div>
                }
                // **FIM DA CORREÇÃO**

                <a asp-controller="Dashboard" asp-action="Index" class="header-btn header-btn-primary">
                    Painel
                </a>
            }
            else
            {
                <a asp-controller="Usuarios" asp-action="Login" class="header-btn header-btn-primary">
                    Entrar
                </a>
            }
        </div>

        <button class="header-mobile-toggle" id="mobile-menu-toggle" aria-label="Menu">
            <i class="bi bi-list"></i>
        </button>
    </div>

    <nav id="mobile-nav-drawer" class="mobile-nav-drawer">
        <ul class="mobile-nav-links">

            <li class="mobile-dropdown">
                <button class="mobile-dropdown-toggle">Finanças <i class="bi bi-chevron-down"></i></button>
                <ul class="mobile-dropdown-menu">
                    <li><a asp-controller="Receitas" asp-action="Index" data-dismiss="mobile-nav">Receitas</a></li>
                    <li><a asp-controller="Despesas" asp-action="Index" data-dismiss="mobile-nav">Despesas</a></li>
                    <li><a asp-controller="Historico" asp-action="Index" data-dismiss="mobile-nav">Histórico</a></li>
                    <li><a asp-controller="Categories" asp-action="Index" data-dismiss="mobile-nav">Categorias</a></li>
                </ul>
            </li>

            <li class="mobile-dropdown">
                <button class="mobile-dropdown-toggle">Planejamento <i class="bi bi-chevron-down"></i></button>
                <ul class="mobile-dropdown-menu">
                    <li><a asp-controller="Budgets" asp-action="Index" data-dismiss="mobile-nav">Orçamentos</a></li>
                    <li><a asp-controller="MetasFinanceiras" asp-action="Index" data-dismiss="mobile-nav">Objetivos</a></li>
                    <li><a asp-controller="ProjecaoFinanceira" asp-action="Index" data-dismiss="mobile-nav">Projeção</a></li>
                </ul>
            </li>

            <li class="mobile-dropdown">
                <button class="mobile-dropdown-toggle">Corporativo <i class="bi bi-chevron-down"></i></button>
                <ul class="mobile-dropdown-menu">
                    <li><a asp-controller="DreGerencial" asp-action="Index" data-dismiss="mobile-nav">DRE Gerencial</a></li>
                    <li><a asp-controller="KpisCorporativos" asp-action="Index" data-dismiss="mobile-nav">KPIs Corporativos</a></li>
                </ul>
            </li>

            <li class="mobile-dropdown">
                <button class="mobile-dropdown-toggle">Análises <i class="bi bi-chevron-down"></i></button>
                <ul class="mobile-dropdown-menu">
                    <li><a asp-controller="Relatorios" asp-action="Index" data-dismiss="mobile-nav">Relatórios</a></li>
                    <li><a asp-controller="TendenciaFinanceira" asp-action="Index" data-dismiss="mobile-nav">Tendências</a></li>
                </ul>
            </li>

            <li class="mobile-dropdown">
                <button class="mobile-dropdown-toggle">Conteúdo <i class="bi bi-chevron-down"></i></button>
                <ul class="mobile-dropdown-menu">
                    <li><a asp-controller="EducacaoFinanceira" asp-action="Index" data-dismiss="mobile-nav">Aprender</a></li>
                    <li><a asp-controller="Artigos" asp-action="Index" data-dismiss="mobile-nav">Artigos</a></li>
                    <li><a asp-controller="Noticias" asp-action="Index" data-dismiss="mobile-nav">Notícias</a></li>
                </ul>
            </li>

            <li class="mobile-dropdown">
                <button class="mobile-dropdown-toggle">Ferramentas <i class="bi bi-chevron-down"></i></button>
                <ul class="mobile-dropdown-menu">
                    <li><a asp-controller="Ferramentas" asp-action="CalculadoraDeMetas" data-dismiss="mobile-nav">Calculadora</a></li>
                    <li><a asp-controller="Ferramentas" asp-action="JurosCompostos" data-dismiss="mobile-nav">Juros Compostos</a></li>
                    <li><a asp-controller="ConversorEnergias" asp-action="Index" data-dismiss="mobile-nav">Energia</a></li>
                </ul>
            </li>

            @if (User.Identity != null && User.Identity.IsAuthenticated)
            {
                <li><a asp-controller="Dashboard" asp-action="Index" data-dismiss="mobile-nav" class="text-primary">Painel</a></li>
                @if (User.IsInRole("Administrador"))
                {
                    <li><a asp-controller="Usuarios" asp-action="Index" data-dismiss="mobile-nav" class="text-danger">Admin</a></li>
                }
                <li><a asp-controller="Usuarios" asp-action="Logout" data-dismiss="mobile-nav" class="text-danger">Sair</a></li>
            }
            else
            {
                <li><a asp-controller="Usuarios" asp-action="Login" data-dismiss="mobile-nav" class="text-primary">Entrar</a></li>
            }
        </ul>
    </nav>

    <button id="header-toggle-tab" class="header-toggle-tab" title="Alternar Menu">
        <i class="bi bi-chevron-up"></i>
    </button>
</header>