@model savemoney.Models.RelatorioTendenciaViewModel

@{
    ViewData["Title"] = "Resultado da Análise";
}

@section css {
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="~/css/tendenciaFinanceiraResultado.css" asp-append-version="true" />
}

<div class="background-fixed-image" aria-hidden="true"></div>

<main class="tendencia-page-main fade-in">

    <!-- Page Header -->
    <header class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <span class="material-symbols-outlined page-icon" aria-hidden="true">analytics</span>
                Resultado da Análise
            </h1>
        </div>
        <a asp-action="Index" class="btn-action btn-secondary">
            <span class="material-symbols-outlined" aria-hidden="true">arrow_back</span>
            Nova Análise
        </a>
    </header>

    <!-- Dados Insuficientes -->
    @if (!Model.DadosSuficientes)
    {
        <div class="alert alert-warning">
            <span class="material-symbols-outlined alert-icon" aria-hidden="true">warning</span>
            <div class="alert-content">
                <h2 class="alert-title">Dados Insuficientes</h2>
                <p class="alert-text">@Model.MensagemTendencia</p>
            </div>
        </div>

        @foreach (var alerta in Model.Alertas)
        {
            <div class="alert alert-info">
                <span class="material-symbols-outlined alert-icon" aria-hidden="true">info</span>
                <span>@alerta</span>
            </div>
        }

        <a asp-controller="Receitas" asp-action="Create" class="btn-action btn-success">
            <span class="material-symbols-outlined" aria-hidden="true">add</span>
            Adicionar Receitas
        </a>

        return;
    }

    <!-- Summary Banner -->
    <section class="summary-banner glass-panel">
        <h2 class="summary-title">@Model.MensagemTendencia</h2>
        <div class="summary-grid">
            <article class="summary-stat">
                <h3 class="stat-label">Período Analisado</h3>
                <p class="stat-value">@Model.DataInicio.ToString("MMM/yyyy") - @Model.DataFim.ToString("MMM/yyyy")</p>
                <small class="stat-subtitle">@Model.PeriodoMeses @(Model.PeriodoMeses == 1 ? "mês" : "meses")</small>
            </article>

            <article class="summary-stat">
                <h3 class="stat-label">Saldo Atual</h3>
                <p class="stat-value">@Model.SaldoAtual.ToString("C")</p>
                <small class="stat-subtitle">posição atual</small>
            </article>

            <article class="summary-stat">
                <h3 class="stat-label">Variação Total</h3>
                <p class="stat-value stat-value-dynamic">
                    @Model.VariacaoPercentualTotal.ToString("F1")%
                    @if (Model.TendenciaIdentificada == savemoney.Models.TipoTendencia.Crescente)
                    {
                        <span class="material-symbols-outlined stat-icon stat-icon-success" aria-hidden="true">trending_up</span>
                    }
                    else if (Model.TendenciaIdentificada == savemoney.Models.TipoTendencia.Decrescente)
                    {
                        <span class="material-symbols-outlined stat-icon stat-icon-danger" aria-hidden="true">trending_down</span>
                    }
                    else
                    {
                        <span class="material-symbols-outlined stat-icon stat-icon-warning" aria-hidden="true">trending_flat</span>
                    }
                </p>
                <small class="stat-subtitle">no período</small>
            </article>
        </div>
    </section>

    <!-- Metrics Cards -->
    <section class="metrics-section">
        <div class="metrics-grid">
            <article class="metric-card glass-panel">
                <div class="metric-icon-wrapper metric-icon-success">
                    <span class="material-symbols-outlined" aria-hidden="true">account_balance</span>
                </div>
                <div class="metric-content">
                    <h3 class="metric-label">Média de Receitas</h3>
                    <p class="metric-value metric-value-success">@Model.MediaReceitas.ToString("C")</p>
                    <small class="metric-subtitle">por mês</small>
                </div>
            </article>

            <article class="metric-card glass-panel">
                <div class="metric-icon-wrapper metric-icon-danger">
                    <span class="material-symbols-outlined" aria-hidden="true">shopping_cart</span>
                </div>
                <div class="metric-content">
                    <h3 class="metric-label">Média de Despesas</h3>
                    <p class="metric-value metric-value-danger">@Model.MediaDespesas.ToString("C")</p>
                    <small class="metric-subtitle">por mês</small>
                </div>
            </article>

            <article class="metric-card glass-panel">
                <div class="metric-icon-wrapper metric-icon-primary">
                    <span class="material-symbols-outlined" aria-hidden="true">account_balance_wallet</span>
                </div>
                <div class="metric-content">
                    <h3 class="metric-label">Média de Saldo</h3>
                    <p class="metric-value metric-value-primary">@Model.MediaSaldo.ToString("C")</p>
                    <small class="metric-subtitle">por mês</small>
                </div>
            </article>
        </div>
    </section>

    <!-- Chart Section -->
    <section class="chart-section glass-panel">
        <h2 class="section-title">
            <span class="material-symbols-outlined" aria-hidden="true">show_chart</span>
            Evolução Financeira
        </h2>
        <div class="chart-wrapper">
            <canvas id="graficoTendencia"
                    role="img"
                    aria-label="Gráfico de evolução financeira ao longo do tempo"
                    data-labels='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DadosMensais.Select(d => d.MesAno).ToList()))'
                    data-receitas='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DadosMensais.Select(d => d.TotalReceitas).ToList()))'
                    data-despesas='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DadosMensais.Select(d => d.TotalDespesas).ToList()))'
                    data-saldos='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DadosMensais.Select(d => d.Saldo).ToList()))'></canvas>
        </div>
    </section>

    <!-- Best/Worst Month -->
    <div class="month-comparison">
        <article class="month-card glass-panel card-success">
            <div class="month-header">
                <span class="material-symbols-outlined month-icon" aria-hidden="true">star</span>
                <h3 class="month-title">Melhor Mês</h3>
            </div>
            <p class="month-value">@Model.MelhorMes</p>
        </article>

        <article class="month-card glass-panel card-danger">
            <div class="month-header">
                <span class="material-symbols-outlined month-icon" aria-hidden="true">warning</span>
                <h3 class="month-title">Pior Mês</h3>
            </div>
            <p class="month-value">@Model.PiorMes</p>
        </article>
    </div>

    <!-- Alerts -->
    @if (Model.Alertas.Any())
    {
        <section class="alerts-section glass-panel">
            <h2 class="section-title">
                <span class="material-symbols-outlined" aria-hidden="true">notifications</span>
                Alertas e Observações
            </h2>
            <div class="alerts-list">
                @foreach (var alerta in Model.Alertas)
                {
                    <div class="alert alert-warning">
                        <span class="material-symbols-outlined alert-icon" aria-hidden="true">info</span>
                        <span>@alerta</span>
                    </div>
                }
            </div>
        </section>
    }

    <!-- Detailed Table -->
    <section class="table-section glass-panel">
        <h2 class="section-title">
            <span class="material-symbols-outlined" aria-hidden="true">table_chart</span>
            Detalhamento Mensal
        </h2>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Mês</th>
                        <th class="text-end">Receitas</th>
                        <th class="text-end">Despesas</th>
                        <th class="text-end">Saldo</th>
                        <th class="text-end">Variação</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var dado in Model.DadosMensais)
                    {
                        <tr class="@(dado.IsOutlier ? "row-outlier" : "")">
                            <td class="td-month">
                                @dado.MesAno
                                @if (dado.IsOutlier)
                                {
                                    <span class="material-symbols-outlined outlier-icon" aria-label="Mês atípico" title="Mês atípico">error</span>
                                }
                            </td>
                            <td class="text-end td-value-positive">
                                @dado.TotalReceitas.ToString("C")
                            </td>
                            <td class="text-end td-value-negative">
                                @dado.TotalDespesas.ToString("C")
                            </td>
                            <td class="text-end">
                                <strong class="@(dado.Saldo >= 0 ? "value-positive" : "value-negative")">
                                    @dado.Saldo.ToString("C")
                                </strong>
                            </td>
                            <td class="text-end">
                                @if (dado.VariacaoPercentual.HasValue)
                                {
                                    var variacao = dado.VariacaoPercentual.Value;
                                    <span class="variation @(variacao > 0 ? "variation-positive" : variacao < 0 ? "variation-negative" : "variation-neutral")">
                                        @(variacao > 0 ? "+" : "")@variacao.ToString("F1")%
                                    </span>
                                }
                                else
                                {
                                    <span class="variation variation-neutral">-</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (dado.Saldo >= 0)
                                {
                                    <span class="status-badge status-success">Positivo</span>
                                }
                                else
                                {
                                    <span class="status-badge status-danger">Negativo</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>

</main>

@section Scripts {
    <script src="~/js/tendenciaFinanceiraResultado.js" asp-append-version="true"></script>
}