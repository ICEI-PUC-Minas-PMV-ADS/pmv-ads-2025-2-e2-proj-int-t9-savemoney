@model savemoney.Models.RelatorioTendenciaViewModel

@{
    ViewData["Title"] = "Resultado da Análise";
}

<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <!-- Cabeçalho -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>📊 Resultado da Análise</h2>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Nova Análise
                </a>
            </div>

            <!-- Verifica se há dados suficientes -->
            @if (!Model.DadosSuficientes)
            {
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Dados Insuficientes</strong><br />
                    @Model.MensagemTendencia
                </div>

                @foreach (var alerta in Model.Alertas)
                {
                    <div class="alert alert-info">@alerta</div>
                }

                <a asp-controller="Receita" asp-action="Create" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Adicionar Receitas
                </a>

                return;
            }

            <!-- Card de Resumo Principal -->
            <div class="card mb-4 shadow-lg border-0">
                <div class="card-body text-center py-4"
                     style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 class="mb-3">@Model.MensagemTendencia</h3>
                    <div class="row">
                        <div class="col-md-4">
                            <h5>Período Analisado</h5>
                            <p class="fs-5 mb-0">
                                @Model.DataInicio.ToString("dd/MM/yyyy") até @Model.DataFim.ToString("dd/MM/yyyy")
                            </p>
                            <small>(@Model.PeriodoMeses meses)</small>
                        </div>
                        <div class="col-md-4">
                            <h5>Saldo Atual</h5>
                            <p class="fs-4 mb-0">
                                <strong>R$ @Model.SaldoAtual.ToString("N2")</strong>
                            </p>
                        </div>
                        <div class="col-md-4">
                            <h5>Variação Total</h5>
                            <p class="fs-4 mb-0">
                                <strong>@Model.VariacaoPercentualTotal.ToString("F1")%</strong>
                            </p>
                            @if (Model.TendenciaIdentificada == savemoney.Models.TipoTendencia.Crescente)
                            {
                                <i class="bi bi-arrow-up-circle fs-3 text-success"></i>
                            }
                            else if (Model.TendenciaIdentificada == savemoney.Models.TipoTendencia.Decrescente)
                            {
                                <i class="bi bi-arrow-down-circle fs-3 text-danger"></i>
                            }
                            else
                            {
                                <i class="bi bi-arrow-right-circle fs-3 text-warning"></i>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cards de Métricas -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center">
                            <i class="bi bi-arrow-up-circle text-success fs-1"></i>
                            <h6 class="mt-2">Média Receitas</h6>
                            <h4 class="text-success">R$ @Model.MediaReceitas.ToString("N2")</h4>
                            <small class="text-muted">por mês</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center">
                            <i class="bi bi-arrow-down-circle text-danger fs-1"></i>
                            <h6 class="mt-2">Média Despesas</h6>
                            <h4 class="text-danger">R$ @Model.MediaDespesas.ToString("N2")</h4>
                            <small class="text-muted">por mês</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-body text-center">
                            <i class="bi bi-wallet2 text-primary fs-1"></i>
                            <h6 class="mt-2">Média Saldo</h6>
                            <h4 class="text-primary">R$ @Model.MediaSaldo.ToString("N2")</h4>
                            <small class="text-muted">por mês</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-graph-up"></i>
                        Evolução Financeira
                    </h5>
                    <canvas id="graficoTendencia" height="80"></canvas>
                </div>
            </div>

            <!-- Destaques -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow-sm border-success">
                        <div class="card-body">
                            <h6 class="card-title text-success">
                                <i class="bi bi-star-fill"></i>
                                Melhor Mês
                            </h6>
                            <p class="fs-5 mb-0">@Model.MelhorMes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm border-danger">
                        <div class="card-body">
                            <h6 class="card-title text-danger">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                Pior Mês
                            </h6>
                            <p class="fs-5 mb-0">@Model.PiorMes</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas -->
            @if (Model.Alertas.Any())
            {
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-bell-fill text-warning"></i>
                            Alertas e Observações
                        </h5>
                        <ul class="list-group list-group-flush">
                            @foreach (var alerta in Model.Alertas)
                            {
                                <li class="list-group-item">@alerta</li>
                            }
                        </ul>
                    </div>
                </div>
            }

            <!-- Tabela de Dados Mensais -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-table"></i>
                        Detalhamento Mensal
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Mês</th>
                                    <th class="text-end">Receitas</th>
                                    <th class="text-end">Despesas</th>
                                    <th class="text-end">Saldo</th>
                                    <th class="text-end">Variação</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var dado in Model.DadosMensais)
                                {
                                    <tr class="@(dado.IsOutlier ? "table-warning" : "")">
                                        <td>
                                            @dado.MesAno
                                            @if (dado.IsOutlier)
                                            {
                                                <i class="bi bi-exclamation-circle text-warning"
                                                   title="Valor atípico detectado"></i>
                                            }
                                        </td>
                                        <td class="text-end text-success">
                                            R$ @dado.TotalReceitas.ToString("N2")
                                        </td>
                                        <td class="text-end text-danger">
                                            R$ @dado.TotalDespesas.ToString("N2")
                                        </td>
                                        <td class="text-end @(dado.Saldo >= 0 ? "text-success" : "text-danger")">
                                            <strong>R$ @dado.Saldo.ToString("N2")</strong>
                                        </td>
                                        <td class="text-end">
                                            @if (dado.VariacaoPercentual.HasValue)
                                            {
                                                var variacao = dado.VariacaoPercentual.Value;
                                                <span class="@(variacao > 0 ? "text-success" : variacao < 0 ? "text-danger" : "text-muted")">
                                                    @(variacao > 0 ? "+" : "")@variacao.ToString("F1")%
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            @if (dado.Saldo >= 0)
                                            {
                                                <span class="badge bg-success">Positivo</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Negativo</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // Dados do gráfico vindos do Model
        const labels = @Html.Raw(Json.Serialize(Model.DadosMensais.Select(d => d.MesAno)));
        const receitas = @Html.Raw(Json.Serialize(Model.DadosMensais.Select(d => d.TotalReceitas)));
        const despesas = @Html.Raw(Json.Serialize(Model.DadosMensais.Select(d => d.TotalDespesas)));
        const saldos = @Html.Raw(Json.Serialize(Model.DadosMensais.Select(d => d.Saldo)));

        // Configuração do gráfico
        const ctx = document.getElementById('graficoTendencia').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Receitas',
                        data: receitas,
                        borderColor: 'rgb(40, 167, 69)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Despesas',
                        data: despesas,
                        borderColor: 'rgb(220, 53, 69)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Saldo',
                        data: saldos,
                        borderColor: 'rgb(13, 110, 253)',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 3
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {
                                    minimumFractionDigits: 2
                                });
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        }
                    }
                }
            }
        });
    </script>
}