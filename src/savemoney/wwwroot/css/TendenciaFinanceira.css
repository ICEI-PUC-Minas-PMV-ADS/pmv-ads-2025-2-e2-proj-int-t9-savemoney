// TendenciaFinanceira.js - Sistema de Análise de Tendências Financeiras
// Save Money - ASP.NET Core MVC (.NET 8)
// Versão: Compatível com SELECT de meses

// ============================================
// 1. INICIALIZAÇÃO E DETECÇÃO DE PÁGINA
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('📊 Tendência Financeira JS carregado');
    
    // Detectar qual página está ativa
    const isIndexPage = document.getElementById('meses') !== null;
    const isResultadoPage = document.getElementById('graficoTendencia') !== null;
    
    if (isIndexPage) {
        console.log('✅ Página Index detectada');
        inicializarFormulario();
    }
    
    if (isResultadoPage) {
        console.log('✅ Página Resultado detectada');
        inicializarGrafico();
        inicializarAnimacoes();
    }
});

// ============================================
// 2. FORMULÁRIO - VALIDAÇÕES E INTERATIVIDADE
// ============================================

function inicializarFormulario() {
    const form = document.querySelector('form[action*="GerarAnalise"]');
    const btnGerar = document.querySelector('.btn-tendencia');
    const selectMeses = document.getElementById('meses');
    if (!form || !selectMeses)

{
    console .error('❌ Formulário ou select de meses não encontrado');
    return;
}

// Adicionar feedback visual no select
selectMeses.addEventListener('change', function() {
        this.classList.remove('is-invalid');
        
        if (this.value) {
            this.classList.add('is-valid');
            mostrarInfoPeriodo(parseInt(this.value));
        } else {
            this.classList.remove('is-valid');
            esconderInfoPeriodo();
        }
    });

// Submissão do formulário
form.addEventListener('submit', function(e) {
        if (!validarFormulario()) {
            e.preventDefault();
            return false;
        }
        
        // Mostrar loading no botão
        if (btnGerar) {
            btnGerar.disabled = true;
            btnGerar.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Analisando...';
        }
    });

console.log('✅ Formulário inicializado com validações');
}

function validarFormulario() {
    const selectMeses = document.getElementById('meses');
    // Limpar validações anteriores selectMeses.classList.remove('is-invalid', 'is-valid');
    // Validar se um período foi selecionado if (!selectMeses.value || selectMeses.value === '')

{
    selectMeses .classList.add('is-invalid');
    mostrarErro('Por favor, selecione um período de análise');
    selectMeses .focus();
    return false;
}

const meses = parseInt(selectMeses.value);

// Validar valor mínimo e máximo
if (meses < 1 || meses > 12) {
    selectMeses .classList.add('is-invalid');
    mostrarErro('O período deve estar entre 1 e 12 meses');
    return false;
}

selectMeses.classList.add('is-valid');
console.log('✅ Formulário válido - Período:', meses, 'meses');
return true;
}

function mostrarErro(mensagem) {
    // Verificar se já existe um alerta de erro let alertErro = document.querySelector('.alert-erro-validacao');
    if (!alertErro)

{
    // Criar novo alerta alertErro = document.createElement('div');
    alertErro .className = 'alert-custom alert-danger mt-3 alert-erro-validacao';
    alertErro .innerHTML = ` <i class="bi bi-exclamation-triangle me-2"></i> <span>$

{
    mensagem
}

</span >
`;

// Inserir após o formulário
const form = document.querySelector('form[action*="GerarAnalise"]');
const formParent = form.parentElement;
formParent.appendChild(alertErro);
}

else {
    // Atualizar mensagem existente alertErro.querySelector('span').textContent = mensagem;
}

// Adicionar animação shake
alertErro.classList.add('animate-shake');
setTimeout(() => {
        alertErro.classList.remove('animate-shake');
    }, 500);
}

function mostrarInfoPeriodo(meses) {
    // Remover info anterior se existir esconderInfoPeriodo();
    // Criar mensagem informativa const infoDiv = document.createElement('div');
    infoDiv .className = 'alert-custom alert-info mt-3 alert-info-periodo';
    infoDiv .style.animation = 'fade-in-up 0.3s ease-out';
    let icone = '📊';
    let texto = '';
    if (meses === 1)

{
    icone = '🗓️';
    texto = 'Análise de <strong>1 mês</strong> - Ideal para verificar mudanças recentes';
}

else if (meses <= 3) {
    icone = '📅';
    texto = `Análise de <strong>$

{
    meses
}

meses</strong > - Período recomendado para identificar tendências`;
}

else if (meses <= 6) {
    icone = '📊';
    texto = `Análise de <strong>$

{
    meses
}

meses</strong > - Ótimo para análises de médio prazo`;
}

else {
    icone = '📈';
    texto = `Análise de <strong>$

{
    meses
}

meses</strong > - Ideal para identificar padrões anuais`;
}

infoDiv.innerHTML = `
<i class="bi bi-info-circle me-2" > </i >
<span > $ {
    icone
}

$ {
    texto
}

</span >
`;

// Inserir após o formulário
const form = document.querySelector('form[action*="GerarAnalise"]');
const formParent = form.parentElement;
formParent.appendChild(infoDiv);
}

function esconderInfoPeriodo() {
    const infoExistente = document.querySelector('.alert-info-periodo');
    if (infoExistente)

{
    infoExistente .remove();
}

const erroExistente = document.querySelector('.alert-erro-validacao');
if (erroExistente) {
    erroExistente .remove();
}

}

// ============================================
// 3. GRÁFICO CHART.JS - PÁGINA RESULTADO
// ============================================

let chartInstance = null;

function inicializarGrafico() {
    const canvas = document.getElementById('graficoTendencia');
    if (!canvas)

{
    console .error('❌ Canvas do gráfico não encontrado');
    return;
}

// Buscar dados do gráfico (passados via data attributes)
const dadosJson = canvas.getAttribute('data-grafico');

if (!dadosJson) {
    console .error('❌ Dados do gráfico não encontrados');
    return;
}

try {
    const dados = JSON.parse(dadosJson);
    console .log('📊 Dados do gráfico:', dados);
    criarGrafico(canvas, dados);
}

catch (error) {
    console .error('❌ Erro ao parsear dados do gráfico:', error);
}

}

function criarGrafico(canvas, dados) {
    const ctx = canvas.getContext('2d');
    // Destruir gráfico anterior se existir if (chartInstance)

{
    chartInstance .destroy();
}

// Configuração do gráfico
chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dados.labels,
            datasets: [
                {
                    label: 'Receitas',
                    data: dados.receitas,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 6,
                    pointHoverRadius: 9,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverBorderWidth: 3
                },
                {
                    label: 'Despesas',
                    data: dados.despesas,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 6,
                    pointHoverRadius: 9,
                    pointBackgroundColor: '#ef4444',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverBorderWidth: 3
                },
                {
                    label: 'Saldo',
                    data: dados.saldos,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 6,
                    pointHoverRadius: 9,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverBorderWidth: 3,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#f5f5ff',
                        font: {
                            family: 'Inter',
                            size: 13,
                            weight: '600'
                        },
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(27, 29, 41, 0.95)',
                    titleColor: '#f5f5ff',
                    bodyColor: '#aaaaaa',
                    borderColor: 'rgba(59, 130, 246, 0.3)',
                    borderWidth: 1,
                    padding: 15,
                    displayColors: true,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += formatarMoeda(context.parsed.y);
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#aaaaaa',
                        font: {
                            family: 'Inter',
                            size: 12
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#aaaaaa',
                        font: {
                            family: 'Inter',
                            size: 12
                        },
                        callback: function(value) {
                            return formatarMoedaCurta(value);
                        }
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeInOutQuart'
            }
        }
    });

console.log('✅ Gráfico Chart.js criado com sucesso');
}

// ============================================
// 4. ANIMAÇÕES E INTERATIVIDADE
// ============================================

function inicializarAnimacoes() {
    // Animar cards ao carregar const cards = document.querySelectorAll('.metric-card, .glass-card');
    cards .forEach((card, index) => {
        setTimeout(() => {
            card.classList.add('animate-fade-in');
        }, index * 100);
    });
    // Animar números (counter animation) animarNumeros();
    // Adicionar efeitos hover nos cards adicionarEfeitosHover();
    // Animar badges de tendência animarBadges();
    console .log('✅ Animações inicializadas');
}

function animarNumeros() {
    const numeros = document.querySelectorAll('.metric-value, .summary-stat p');
    numeros .forEach(elemento => {
        const textoOriginal = elemento.textContent;
        const valorNumerico = parseFloat(textoOriginal.replace(/[^0-9,-]/g, '').replace(',', '.'));
        
        if (isNaN(valorNumerico)) return;
        
        animarContador(elemento, 0, valorNumerico, 1200, textoOriginal);
    });
}

function animarContador(elemento, inicio, fim, duracao, formatoOriginal) {
    const incremento = (fim - inicio) / (duracao / 16);
    let atual = inicio;
    const timer = setInterval(() => {
        atual += incremento;
        
        if ((incremento > 0 && atual >= fim) || (incremento < 0 && atual <= fim)) {
            atual = fim;
            clearInterval(timer);
        }
        
        // Manter formato original
        if (formatoOriginal.includes('R$')) {
            elemento.textContent = formatarMoeda(atual);
        } else if (formatoOriginal.includes('%')) {
            elemento.textContent = atual.toFixed(1) + '%';
        } else {
            elemento.textContent = Math.round(atual).toString();
        }
    }, 16);
}

function adicionarEfeitosHover() {
    const cards = document.querySelectorAll('.metric-card, .glass-card');
    cards .forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
}

function animarBadges() {
    const badges = document.querySelectorAll('.badge-custom');
    badges .forEach((badge, index) => {
        setTimeout(() => {
            badge.style.animation = 'pulse 0.5s ease-out';
        }, 500 + (index * 100));
    });
}

// ============================================
// 5. UTILITÁRIOS - FORMATAÇÃO
// ============================================

function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(valor);
}

function formatarMoedaCurta(valor) {
    if (Math.abs(valor) >= 1000000)

{
    return 'R$ ' + (valor / 1000000).toFixed(1) + 'M';
}

else if (Math.abs(valor) >= 1000) {
    return 'R$ ' + (valor / 1000).toFixed(1) + 'K';
}

return 'R$ ' + valor.toFixed(0);
}

// ============================================
// 6. ANIMAÇÕES CSS ADICIONAIS
// ============================================

// Adicionar estilos de animação dinamicamente se não existirem
if (!document.getElementById('tendencia-animations')) {
    const style = document.createElement('style');
    style .id = 'tendencia-animations';
    style .textContent = ` @keyframes pulse

{
    0%, 100%

{
    transform: scale(1);
}

50% {
    transform: scale(1.05);
}

}

@keyframes animate-shake {
    0%, 100% {
        transform: translateX(0);
    }

    25% {
        transform: translateX(-10px);
    }

    75% {
        transform: translateX(10px);
    }
}

.animate-shake {
    animation: animate-shake 0.5s ease-in-out;
}

.is-valid {
    border-color: #10b981 !important;
}

.is-invalid {
    border-color: #ef4444 !important;
}

`;
document.head.appendChild(style);
}

// ============================================
// 7. EXPORT PARA DEBUGGING
// ============================================

window.TendenciaFinanceira = {
    validarFormulario, inicializarGrafico, chartInstance: () => chartInstance
}

;

console.log('✅ Módulo TendenciaFinanceira carregado e pronto');
